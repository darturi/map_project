{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />

    <style>
        .flex-container {
            display: flex;
        }

        .flex-child-one {
            flex: 1;
            border: 1px solid black;
        }

        .flex-child-two {
            flex: 0.3;
            border: 1px solid blue;
        }

        .flex-child-one:first-child {
            margin-right: 20px;
        }
    </style>

    <title>Document</title>
</head>

<body>
    <h1>Django Profile</h1>

    <div class="flex-container">

        <!--Div containing map-->
        <div id='map' style='width: 70%; height: 550px;' class="flex-child-one"></div>
        <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuaWVsYXJ0dXJpIiwiYSI6ImNsbTJ2c2ZrYjF6bHozcm85d3phc2c1bTUifQ.Ubn6vNMeUlWJ4iBomj9_BA';
            const map = new mapboxgl.Map({
                container: 'map', // container ID
                style: 'mapbox://styles/mapbox/streets-v12', // style URL
                center: [-73.577207, 45.507601], // starting position [lng, lat]
                zoom: 9, // starting zoom
                //interactive: true,
            });
            /*

            const changeText = document.querySelector("#change-text");

            class ClickableMarker extends mapboxgl.Marker {
                // new method onClick, sets _handleClick to a function you pass in
                onClick(handleClick) {
                    this._handleClick = handleClick;
                    return this;
                }

                // the existing _onMapClick was there to trigger a popup
                // but we are hijacking it to run a function we define
                _onMapClick(e) {
                    const targetElement = e.originalEvent.target;
                    const element = this._element;

                    if (this._handleClick && (targetElement === element || element.contains((targetElement)))) {
                        this._handleClick();
                    }
                }
            };
            */

            {% for address in addresses %}


            var marker = new mapboxgl.Marker()
                .setLngLat(['{{ address.long }}', '{{ address.lat }}'])
                .setPopup(new mapboxgl.Popup().setHTML("<p>{{ address.address }}</p> <form action='{{ address.get_absolute_url }}'><input type='submit' value='discuss'/></form>"))
                .addTo(map);


            /*
            new ClickableMarker()
                .setLngLat(['{{ address.long }}', '{{ address.lat }}'])
                //.setPopup(new mapboxgl.Popup().setHTML("<p>{{ address.address }}</p>"))
                .onClick(function () {
                    changeText.textContent = "CHANGED";
                })
                .addTo(map);
                */

            /*
            const marker = new mapboxgl.Marker()
                .setLngLat(['{{ address.long }}', '{{ address.lat }}'])
                .setPopup(new mapboxgl.Popup().setHTML("<p>{{ address.address }}</p>"))
                .addTo(this.map);
            // use GetElement to get HTML Element from marker and add event
            marker.getElement().addEventListener('click', () => {
                alert("Clicked");
            });
            */
            /*
            this.service.getAllData().forEach(e => {
                // create MapBox Marker
                const marker = new mapboxgl.Marker().setLngLat([e.lon, e.lat]).addTo(this.map);
                // use GetElement to get HTML Element from marker and add event
                marker.getElement().addEventListener('click', () => {
                    alert("Clicked");
                });
            });
            */

            {% endfor %}

        </script>

        <!--Div containing form to add markers-->
        <div class="flex-child-two">
            <form method='POST'>
                {% csrf_token %}
                {{ form|crispy }}
                <input type="submit" value="submit address" />
            </form>
        </div>
    </div>
    <!--
    {% for address in addresses %}
    <p>{{ address.long }}</p>
    {% endfor%}
    -->
    <div>
        <p id="change-text">TEXT THAT SHOULD CHANGE</p>
    </div>
</body>

</html>

{% endblock content %}